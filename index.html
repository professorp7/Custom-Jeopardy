<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jeopardy Party ‚Äî Play + Pack Editor</title>
<style>
:root{
  --bg:#0e1021;--panel:#151836;--muted:#9fb0c7;--text:#eaf1fb;--accent:#6ec3ff;--accent2:#a7f3d0;
  --line:#273056;--tile:#0f1530;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:0 auto;padding:16px}
.h-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{background:linear-gradient(180deg,#28315f,#1a2046);border:1px solid #39407a;color:#eaf1fb;padding:10px 14px;border-radius:12px;cursor:pointer}
.btn:hover{filter:brightness(1.08)}
.btn.ghost{background:transparent;border:1px dashed #3a437b}
.btn.small{padding:6px 10px;border-radius:10px;font-size:13px}
.btn.good{background:#16351f;border-color:#246a38}
.btn.bad{background:#3a1417;border-color:#7a2e35}
.btn.warn{background:#3c2a0d;border-color:#90601b}
.input, textarea, select{background:#0e1434;border:1px solid #2b3567;color:#eaf1fb;border-radius:10px;padding:10px}
.input::placeholder, textarea::placeholder{color:#8ea0b6}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.tabs{display:flex;gap:8px;margin:8px 0 16px}
.tab{padding:10px 14px;border-radius:12px;border:1px solid var(--line);cursor:pointer;background:#10153a}
.tab.active{background:#1a2253;box-shadow:inset 0 0 0 1px #4650a6}
.grid{display:grid;gap:8px}
.board{user-select:none}
.board .cell{display:flex;align-items:center;justify-content:center;background:radial-gradient(120px 80px at 50% -20%,#25408d,#0c1a47);border:1px solid #374ea6;border-radius:12px;padding:14px;font-weight:800;text-align:center;min-height:84px;letter-spacing:1.2px;color:#f6d04d;text-shadow:0 2px 0 #1c2a66,0 0 12px rgba(246,208,77,.5);cursor:pointer}
.board .cell.used{background:#0b1130;color:#344}
.board .head{background:linear-gradient(180deg,#24358a 0%,#1a2a71 100%);color:#a7f3d0;text-shadow:none;font-weight:900;border-color:#4258c9}
.flex{display:flex;gap:12px}
.col{flex:1 1 0}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
.hr{height:1px;background:var(--line);margin:12px 0}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0d173b;border:1px solid #2a3b8f}
.score{padding:10px 12px;border-radius:10px;background:#0e1737;border:1px solid #2a3361;display:flex;align-items:center;gap:8px}
.score .p{font-weight:700}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(8,11,24,.7);backdrop-filter:blur(2px);z-index:50}
.modal.show{display:flex}
.sheet{width:min(860px,96vw);max-height:90vh;overflow:auto;background:#0f1434;border:1px solid #39407a;border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.4)}
.sheet .hd{padding:14px 16px;border-bottom:1px solid #2b3567;font-weight:800}
.sheet .bd{padding:16px}
.center{text-align:center}
.timer{font-variant-numeric:tabular-nums;font-size:42px;letter-spacing:2px}
kbd{background:#141a3b;border:1px solid #33407a;padding:2px 6px;border-radius:6px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{color:#a7f3d0;text-align:left;font-size:13px}
.table td{background:#0e1434;border:1px solid #2b3567;padding:8px;border-radius:8px}
.alert{padding:10px 12px;background:#152140;border:1px solid #2b3567;border-radius:10px}
.hidden{display:none}

/* Mobile tweaks */
@media (max-width:800px){
  .grid.board{gap:6px}
  .board .cell{min-height:64px;padding:10px}
}
</style>
</head>
<body>
  <div class="container">
    <div class="h-row">
      <h1 style="margin:6px 0">Jeopardy Party</h1>
      <span class="badge">Single-file ‚Ä¢ Host + Editor</span>
      <span class="badge">Packs saved in LocalStorage</span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="play">‚ñ∂ Play</button>
      <button class="tab" data-tab="editor">‚úç Pack Editor</button>
      <button class="tab" data-tab="packs">üì¶ Packs</button>
      <span class="small" style="margin-left:auto">Tip: Buzzers A S D F / J K L ; or click ‚úã</span>
    </div>

    <!-- PLAY TAB -->
    <section id="tab-play" class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn" id="btnNewGame">New Game</button>
          <button class="btn" id="btnFinal">Final Jeopardy</button>
          <button class="btn ghost" id="btnResetBoard">Reset Board</button>
        </div>
        <div class="row">
          <select id="packSelect" class="input"></select>
          <button class="btn" id="btnLoadPack">Load Pack</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="score" style="flex-wrap:wrap">
          <span class="small">Players</span>
          <input id="playerName" class="input" placeholder="Add player name" style="min-width:180px"/>
          <button class="btn small" id="btnAddPlayer">Add</button>
          <button class="btn small ghost" id="btnClearPlayers">Clear</button>
        </div>
        <div id="players" class="row" style="flex-wrap:wrap"></div>
      </div>

      <div class="hr"></div>

      <div id="boardWrap" class="card" style="background:#0c1130">
        <div id="board" class="grid board"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="badge">Current Pack: <b id="packName">(none)</b></div>
        <div class="badge">Size: <span id="packSize">0√ó0</span></div>
        <div class="badge">Daily Doubles: <span id="ddCount">0</span></div>
        <button class="btn small" id="btnShowLegend">Show Shortcuts</button>
      </div>
    </section>

    <!-- EDITOR TAB -->
    <section id="tab-editor" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <input id="eTitle" class="input" style="min-width:240px" placeholder="Pack title (e.g., Movie Night)"/>
          <label class="badge">Categories <input id="eCols" type="number" class="input" value="5" min="0" max="12" style="width:80px;margin-left:8px"></label>
          <label class="badge">Rows <input id="eRows" type="number" class="input" value="5" min="0" max="12" style="width:80px;margin-left:8px"></label>
          <button class="btn" id="btnBuildGrid">Build Grid</button>
        </div>
        <div class="row">
          <button class="btn" id="btnExportPack">Export JSON</button>
          <label class="btn">
            Import JSON <input id="fileImport" type="file" accept="application/json" style="display:none"/>
          </label>
          <button class="btn good" id="btnSavePack">Save to Browser</button>
          <button class="btn bad" id="btnWipeEditor">Wipe Editor Board</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="eGrid"></div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between">
        <div class="row">
          <label class="badge">Daily Doubles: <span id="eDDCount">0</span></label>
          <button class="btn small warn" id="btnAutoDD">Auto-place 1‚Äì2</button>
        </div>
        <div class="row">
          <label class="badge">Final Question: </label>
          <input id="eFinalQ" class="input" placeholder="Final Jeopardy question" style="min-width:280px">
          <input id="eFinalA" class="input" placeholder="Final Jeopardy answer" style="min-width:220px">
        </div>
      </div>
    </section>

    <!-- PACKS TAB -->
    <section id="tab-packs" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h3 style="margin:0 0 8px">Your Saved Packs</h3>
          <div class="small">Saved locally in your browser. Export to share; others can import JSON.</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnSeedSamples">Load Sample Packs</button>
          <button class="btn bad" id="btnWipePacks">Delete All Packs</button>
        </div>
      </div>
      <div class="hr"></div>
      <table class="table" id="packTable">
        <thead>
          <tr><th>Title</th><th>Size</th><th>Last Saved</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- MODALS -->
  <div id="modalCard" class="modal" aria-hidden="true">
    <div class="sheet">
      <div class="hd row"><span id="mCategory">Category</span><span class="badge" id="mValue">$200</span><span class="badge" id="mFlags"></span><button class="btn small ghost" style="margin-left:auto" id="mClose">‚úñ</button></div>
      <div class="bd">
        <div class="center" style="margin-bottom:8px">
          <div id="mQuestion" style="font-size:28px;line-height:1.3;margin:0 auto 6px;max-width:800px"></div>
          <div class="small" id="mRevealHint">Tap R to reveal answer</div>
        </div>

        <div class="row center" style="justify-content:center;margin:8px 0">
          <button class="btn" id="btnReveal">Reveal Answer</button>
          <button class="btn warn" id="btnTimer">Start 10s Timer</button>
          <button class="btn ghost" id="btnBuzz">‚úã Open Buzzers</button>
        </div>

        <div id="answerWrap" class="center hidden" style="margin:8px 0 12px">
          <div id="mAnswer" style="font-size:26px"></div>
        </div>

        <div id="buzzWrap" class="hidden">
          <div class="alert center">Buzz with keys: <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd> <kbd>F</kbd> ‚Ä¢ <kbd>J</kbd> <kbd>K</kbd> <kbd>L</kbd> <kbd>;</kbd> or click a ‚úã on a player card.
          </div>
          <div id="buzzResult" class="center" style="margin:10px 0;font-size:22px"></div>
        </div>

        <div class="row center" style="justify-content:center;margin-top:10px">
          <button class="btn good" id="btnCorrect">Correct (+)</button>
          <button class="btn bad" id="btnWrong">Wrong (‚Äì)</button>
          <button class="btn ghost" id="btnSkip">Skip</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalLegend" class="modal" aria-hidden="true">
    <div class="sheet">
      <div class="hd">Shortcuts</div>
      <div class="bd">
        <ul>
          <li><kbd>R</kbd> reveal answer</li>
          <li><kbd>T</kbd> start/stop timer</li>
          <li><kbd>B</kbd> open buzzers</li>
          <li><kbd>‚Üê/‚Üí</kbd> navigate unanswered clues in current row</li>
          <li><kbd>Esc</kbd> close card</li>
        </ul>
      </div>
    </div>
  </div>

<script>
/**********************
 * Data structures
 **********************/
/** Pack schema
{
  id: string,
  title: string,
  cols: number, rows: number,
  categories: ["Cat 1", ...], // length cols
  values: [[200,400,600,800,1000], ... per col], // rows per col
  grid: [ // [col][row]
    [{ q:"", a:"", used:false, dd:false }, ...rows],
    ...cols
  ],
  final: { q:"", a:"" }
}
*/

const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const uid = ()=>'p_'+Math.random().toString(36).slice(2,9);
const nowIso = ()=> new Date().toISOString();

const store = {
  get packs(){ return JSON.parse(localStorage.getItem('jp_packs')||'[]'); },
  set packs(v){ localStorage.setItem('jp_packs', JSON.stringify(v)); },
  put(pack){
    const arr = store.packs; const i = arr.findIndex(p=>p.id===pack.id);
    if(i>=0) arr[i]=pack; else arr.push(pack);
    store.packs = arr; refreshPackTable(); refreshPackSelect();
  },
  remove(id){ store.packs = store.packs.filter(p=>p.id!==id); refreshPackTable(); refreshPackSelect(); },
  get(id){ return store.packs.find(p=>p.id===id); }
};

/**********************
 * Global game state
 **********************/
let currentPack=null; // loaded pack
let players=[]; // {id,name,score,key}
let buzzOpen=false, buzzWinner=null, activeCell=null; // {c,r}
let timerInt=null, timerLeft=0;

/**********************
 * UI helpers
 **********************/
function toast(msg){
  const d=document.createElement('div');
  d.textContent=msg; d.style.position='fixed'; d.style.left='50%'; d.style.top='16px'; d.style.transform='translateX(-50%)'; d.style.background='#10204a'; d.style.border='1px solid #2a3b8f'; d.style.color='white'; d.style.padding='8px 12px'; d.style.borderRadius='10px'; d.style.zIndex='80';
  document.body.appendChild(d); setTimeout(()=>d.remove(), 1600);
}

function buildBoard(){
  const board = $('#board');
  board.innerHTML='';
  if(!currentPack){ board.innerHTML='<div class="small">Load a pack to play.</div>'; return; }
  const {cols,rows,categories,values,grid}=currentPack;
  const cs = `repeat(${cols}, 1fr)`; const rs = `repeat(${rows+1}, auto)`;
  board.style.gridTemplateColumns = cs; board.style.gridTemplateRows = rs;
  // headers
  for(let c=0;c<cols;c++){
    const h = document.createElement('div'); h.className='cell head'; h.textContent=categories[c]||`Cat ${c+1}`; h.style.minHeight='72px';
    board.appendChild(h);
  }
  // cells
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell = document.createElement('button'); cell.className='cell';
      const item = grid[c][r];
      cell.dataset.c=c; cell.dataset.r=r; cell.disabled = !!item.used;
      if(item.used) cell.classList.add('used');
      const val = values?.[c]?.[r] ?? ((r+1)*200);
      cell.textContent = item.used?'' : `$${val}`;
      if(item.dd && !item.used){ cell.textContent+=' ‚òÖ'; }
      cell.addEventListener('click', ()=>openCard(c,r));
      board.appendChild(cell);
    }
  }
  $('#packName').textContent = currentPack.title;
  $('#packSize').textContent = `${currentPack.cols}√ó${currentPack.rows}`;
  $('#ddCount').textContent = countDD(currentPack);
}

function refreshPlayers(){
  const wrap = $('#players'); wrap.innerHTML='';
  const keyMap=['A','S','D','F','J','K','L',';'];
  players.forEach((p,i)=>{
    const card=document.createElement('div'); card.className='score';
    card.innerHTML=`<span class="p">${p.name}</span><span class="small">(${p.key||keyMap[i]||'‚úã'})</span>
      <span>‚Ä¢</span><b>${p.score}</b>
      <button class="btn small good" data-d="+100">+100</button>
      <button class="btn small bad" data-d="-100">-100</button>
      <button class="btn small ghost" data-act="buzz">‚úã</button>
      <button class="btn small ghost" data-act="rm">‚úñ</button>`;
    card.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',e=>{
        const d = btn.dataset.d; const act=btn.dataset.act;
        if(d){ p.score += parseInt(d,10); refreshPlayers(); return; }
        if(act==='rm'){ players = players.filter(x=>x.id!==p.id); refreshPlayers(); return; }
        if(act==='buzz'){ if(buzzOpen && !buzzWinner){ buzzWinner=p; showBuzzWinner(p); } }
      });
    });
    wrap.appendChild(card);
  });
}

/**********************
 * Gameplay modals
 **********************/
function openCard(c,r){
  activeCell={c,r}; buzzOpen=false; buzzWinner=null; $('#buzzResult').textContent='';
  const item=currentPack.grid[c][r];
  $('#mCategory').textContent=currentPack.categories[c]||`Cat ${c+1}`;
  $('#mValue').textContent = `$${currentPack.values?.[c]?.[r] ?? (r+1)*200}`;
  $('#mFlags').textContent = item.dd?'DAILY DOUBLE':'';
  $('#mQuestion').textContent=item.q||'(No question)';
  $('#mAnswer').textContent=item.a||'(No answer set)';
  $('#answerWrap').classList.add('hidden');
  $('#buzzWrap').classList.add('hidden');
  $('#modalCard').classList.add('show');
}
function closeCard(){ $('#modalCard').classList.remove('show'); stopTimer(); }
function reveal(){ $('#answerWrap').classList.remove('hidden'); }
function openBuzz(){ buzzOpen=true; buzzWinner=null; $('#buzzWrap').classList.remove('hidden'); $('#buzzResult').textContent='Buzzers open!'; }
function showBuzzWinner(p){ if(!p) return; buzzWinner=p; buzzOpen=false; $('#buzzResult').textContent = `${p.name} buzzed in!`; }
function applyResult(correct){
  if(!activeCell) return; const {c,r}=activeCell; const val = currentPack.values?.[c]?.[r] ?? (r+1)*200;
  if(buzzWinner){ buzzWinner.score += correct? val : -val; }
  currentPack.grid[c][r].used=true; closeCard(); buildBoard(); refreshPlayers();
}

function countDD(pack){ let n=0; for(let c=0;c<pack.cols;c++){ for(let r=0;r<pack.rows;r++){ if(pack.grid[c][r].dd) n++; }} return n; }

/**********************
 * Timer
 **********************/
function startTimer(sec=10){ stopTimer(); timerLeft=sec; $('#btnTimer').textContent=`Stop (${timerLeft})`; timerInt=setInterval(()=>{ timerLeft--; $('#btnTimer').textContent=`Stop (${timerLeft})`; if(timerLeft<=0) stopTimer(); },1000); }
function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; $('#btnTimer').textContent='Start 10s Timer'; }}

/**********************
 * Final Jeopardy (simple flow)
 **********************/
function finalJeopardy(){
  if(!currentPack?.final){ toast('No Final set in this pack.'); return; }
  const q=currentPack.final.q||'(No final question)'; const a=currentPack.final.a||'(No final answer)';
  const wagers={};// name->amount
  const amt = prompt('Enter wagers as name:amount, comma separated (e.g., Alice:500,Bob:1200)');
  if(amt){ amt.split(',').forEach(pair=>{ const [n,v]=pair.split(':'); if(n&&v) wagers[n.trim()]=parseInt(v,10)||0; }); }
  alert('Final Question:\\n\\n'+q+'\\n\\nLock answers, then click OK to reveal answer.');
  alert('Final Answer:\\n\\n'+a);
  const res = prompt('Enter results as name:+/- (e.g., Alice:+, Bob:-)');
  if(res){ res.split(',').forEach(pair=>{ const [n,s]=pair.split(':'); if(!n||!s) return; const p=players.find(x=>x.name.trim().toLowerCase()===n.trim().toLowerCase()); if(!p) return; const w=wagers[p.name]||0; p.score += (s.trim()==='+')? w : -w; }); refreshPlayers(); }
}

/**********************
 * Pack Editor
 **********************/
function wipeEditor(){
  if(!confirm('Completely wipe the editor? This will create an empty 0√ó0 custom pack.')) return;

  // Build an empty pack structure (0x0)
  const fresh = {
    id: uid(),
    title: '',
    cols: 0,
    rows: 0,
    categories: [],
    values: [],
    grid: [],
    final: { q:'', a:'' },
    savedAt: nowIso()
  };

  // Apply and render
  currentPack = fresh;
  $('#eCols').value = 0;
  $('#eRows').value = 0;
  $('#eTitle').value = '';
  $('#eFinalQ').value = '';
  $('#eFinalA').value = '';
  $('#eGrid').innerHTML = '<div class="small">Empty custom pack (0√ó0). Use Build Grid to start again.</div>';
  $('#eDDCount').textContent = '0';
  toast('Editor cleared to 0√ó0 empty pack.');
}

function buildEditorGrid(cols,rows){
  const wrap=$('#eGrid'); wrap.innerHTML='';
  const head=document.createElement('div'); head.className='grid'; head.style.gridTemplateColumns=`repeat(${cols}, 1fr)`; head.style.gap='8px';
  for(let c=0;c<cols;c++){
    const inp=document.createElement('input'); inp.className='input'; inp.placeholder=`Category ${c+1}`; inp.value=currentPack?.categories?.[c]||''; inp.dataset.cat=c; head.appendChild(inp);
  }
  wrap.appendChild(head);

  const body=document.createElement('div'); body.className='grid'; body.style.gridTemplateColumns=`repeat(${cols}, 1fr)`; body.style.gap='8px';
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const card=document.createElement('div'); card.className='card'; card.style.padding='12px';
      const val=((r+1)*200);
      card.innerHTML=`<div class="row" style="justify-content:space-between"><b>$${val}</b><label class="small"><input type="checkbox" data-dd="${c},${r}"> Daily Double</label></div>
      <textarea class="input" rows="3" placeholder="Question" data-q="${c},${r}"></textarea>
      <textarea class="input" rows="2" placeholder="Answer" data-a="${c},${r}"></textarea>`;
      body.appendChild(card);
    }
  }
  wrap.appendChild(body);

  // If editing an existing pack, prefill
  if(currentPack){
    $$('#eGrid [data-cat]').forEach(inp=>{ const c=+inp.dataset.cat; inp.value=currentPack.categories[c]||''; });
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      const item=currentPack.grid?.[c]?.[r];
      const tq=$(`#eGrid [data-q="${c},${r}"]`); const ta=$(`#eGrid [data-a="${c},${r}"]`); const dd=$(`#eGrid [data-dd="${c},${r}"]`);
      if(item){ if(tq) tq.value=item.q||''; if(ta) ta.value=item.a||''; if(dd) dd.checked=!!item.dd; }
    }
    $('#eTitle').value=currentPack.title||'';
    $('#eFinalQ').value=currentPack.final?.q||''; $('#eFinalA').value=currentPack.final?.a||'';
    $('#eDDCount').textContent = countDD(currentPack);
  }
}

function readEditorToPack(){
  const cols=+$('#eCols').value, rows=+$('#eRows').value;
  const categories=[...$$('#eGrid [data-cat]')].map(i=>i.value||'');
  const grid=[...Array(cols)].map(()=>Array(rows).fill(null));
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
    const q=$(`#eGrid [data-q="${c},${r}"]`)?.value||'';
    const a=$(`#eGrid [data-a="${c},${r}"]`)?.value||'';
    const dd=$(`#eGrid [data-dd="${c},${r}"]`)?.checked||false;
    grid[c][r]={q,a,used:false,dd};
  }
  const pack = {
    id: currentPack?.id || uid(),
    title: $('#eTitle').value||'Untitled Pack',
    cols, rows, categories,
    values: [...Array(cols)].map(()=>[...Array(rows)].map((_,r)=>(r+1)*200)),
    grid,
    final: { q: $('#eFinalQ').value||'', a: $('#eFinalA').value||'' },
    savedAt: nowIso()
  };
  return pack;
}

function autoPlaceDD(){
  const cols=+$('#eCols').value, rows=+$('#eRows').value;
  const picks = new Set();
  const attempts = Math.min(2, Math.ceil(rows/3));
  while(picks.size<attempts){
    const c=Math.floor(Math.random()*cols), r=Math.floor(Math.random()*rows);
    picks.add(c+','+r);
  }
  picks.forEach(id=>{ const el=$(`#eGrid [data-dd="${id}"]`); if(el) el.checked=true; });
  $('#eDDCount').textContent=[...$$('#eGrid [data-dd]')].filter(i=>i.checked).length;
}

/**********************
 * Packs table/select
 **********************/
function refreshPackTable(){
  const tbody = $('#packTable tbody'); tbody.innerHTML='';
  store.packs.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.title}</td><td>${p.cols}√ó${p.rows}</td><td>${new Date(p.savedAt||Date.now()).toLocaleString()}</td>
      <td>
        <button class="btn small" data-act="load" data-id="${p.id}">Load</button>
        <button class="btn small" data-act="edit" data-id="${p.id}">Edit</button>
        <button class="btn small bad" data-act="del" data-id="${p.id}">Delete</button>
        <button class="btn small ghost" data-act="download" data-id="${p.id}">Download</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id; const p=store.get(id); if(!p) return;
      switch(btn.dataset.act){
        case 'load': currentPack=JSON.parse(JSON.stringify(p)); buildBoard(); switchTab('play'); break;
        case 'edit': currentPack=JSON.parse(JSON.stringify(p)); $('#eCols').value=p.cols; $('#eRows').value=p.rows; buildEditorGrid(p.cols,p.rows); switchTab('editor'); break;
        case 'del': if(confirm('Delete pack "'+p.title+'"?')){ store.remove(id); if(currentPack?.id===id){ currentPack=null; buildBoard(); } } break;
        case 'download': downloadJSON(p.title.replace(/[^a-z0-9\-_ ]/gi,'_')+'.json', p); break;
      }
    });
  });
}

function refreshPackSelect(){
  const sel=$('#packSelect'); sel.innerHTML='';
  store.packs.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.title; sel.appendChild(o); });
}

/**********************
 * Utilities
 **********************/
function downloadJSON(filename, obj){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 800);
}

function switchTab(name){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $('#tab-play').classList.toggle('hidden', name!=='play');
  $('#tab-editor').classList.toggle('hidden', name!=='editor');
  $('#tab-packs').classList.toggle('hidden', name!=='packs');
}

/**********************
 * Events
 **********************/
// Tabs
$$('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
$('#btnShowLegend').addEventListener('click',()=>$('#modalLegend').classList.add('show'));
$('#modalLegend').addEventListener('click',e=>{ if(e.target.id==='modalLegend') $('#modalLegend').classList.remove('show'); });

// Players
$('#btnAddPlayer').addEventListener('click',()=>{ const name=$('#playerName').value.trim(); if(!name) return; players.push({id:uid(),name,score:0}); $('#playerName').value=''; refreshPlayers(); });
$('#btnClearPlayers').addEventListener('click',()=>{ if(confirm('Clear all players?')){ players=[]; refreshPlayers(); } });

// Keyboard buzz
window.addEventListener('keydown',e=>{
  const key = e.key.toLowerCase();
  const mapping = ['a','s','d','f','j','k','l',';'];
  if(buzzOpen && !buzzWinner){
    const idx = mapping.indexOf(key);
    if(idx>=0 && players[idx]){ showBuzzWinner(players[idx]); }
  }
  if($('#modalCard').classList.contains('show')){
    if(key==='r') reveal();
    if(key==='t') { if(timerInt) stopTimer(); else startTimer(10); }
    if(key==='b') openBuzz();
    if(key==='escape') closeCard();
  }
});

// Card modal buttons
$('#btnReveal').addEventListener('click',reveal);
$('#btnTimer').addEventListener('click',()=>{ if(timerInt) stopTimer(); else startTimer(10); });
$('#btnBuzz').addEventListener('click',openBuzz);
$('#btnCorrect').addEventListener('click',()=>applyResult(true));
$('#btnWrong').addEventListener('click',()=>applyResult(false));
$('#btnSkip').addEventListener('click',closeCard);
$('#mClose').addEventListener('click',closeCard);
$('#modalCard').addEventListener('click',e=>{ if(e.target.id==='modalCard') closeCard(); });

// Play: packs
$('#btnLoadPack').addEventListener('click',()=>{ const id=$('#packSelect').value; const p=store.get(id); if(p){ currentPack=JSON.parse(JSON.stringify(p)); buildBoard(); switchTab('play'); }});
$('#btnNewGame').addEventListener('click',()=>{ if(!currentPack){ toast('Load a pack first.'); return; } // reset used flags
  currentPack.grid.forEach(col=>col.forEach(cell=>cell.used=false)); buildBoard(); });
$('#btnResetBoard').addEventListener('click',()=>{ if(confirm('Reset used clues on this board?')){ currentPack.grid.forEach(col=>col.forEach(cell=>cell.used=false)); buildBoard(); }});
$('#btnFinal').addEventListener('click',finalJeopardy);

// Editor
$('#btnBuildGrid').addEventListener('click',()=>{ currentPack = readEditorToPack(); buildEditorGrid(currentPack.cols,currentPack.rows); $('#eDDCount').textContent = countDD(currentPack); toast('Grid built.'); });
$('#btnSavePack').addEventListener('click',()=>{ const pack=readEditorToPack(); pack.savedAt=nowIso(); store.put(pack); toast('Saved to browser.'); });
$('#btnExportPack').addEventListener('click',()=>{ const pack=readEditorToPack(); downloadJSON(pack.title.replace(/[^a-z0-9\-_ ]/gi,'_')+'.json', pack); });
$('#fileImport').addEventListener('change',async (e)=>{
  const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
  try{ const pack=JSON.parse(txt); currentPack=pack; $('#eCols').value=pack.cols; $('#eRows').value=pack.rows; buildEditorGrid(pack.cols, pack.rows); toast('Imported!'); }
  catch(err){ alert('Bad JSON pack.'); }
});
$('#btnAutoDD').addEventListener('click',autoPlaceDD);
$('#btnWipeEditor').addEventListener('click',wipeEditor);

// Packs tab actions
$('#btnSeedSamples').addEventListener('click',()=>{ seedSamples(); refreshPackTable(); refreshPackSelect(); toast('Sample packs added'); });
$('#btnWipePacks').addEventListener('click',()=>{ if(confirm('Delete ALL saved packs?')){ localStorage.removeItem('jp_packs'); refreshPackTable(); refreshPackSelect(); }});

/**********************
 * Samples & init
 **********************/
function makeEmpty(cols=5, rows=5, title='Untitled Pack'){
  return { id:uid(), title, cols, rows,
    categories:[...Array(cols)].map((_,i)=>`Category ${i+1}`),
    values:[...Array(cols)].map(()=>[...Array(rows)].map((_,r)=>(r+1)*200)),
    grid:[...Array(cols)].map(()=>[...Array(rows)].map(()=>({q:'',a:'',used:false,dd:false}))),
    final:{q:'Your final question here', a:'Your final answer here'},
    savedAt: nowIso()
  };
}

function seedSamples(){
  // Sample 1
  const p1=makeEmpty(5,5,'General Trivia');
  p1.categories=['History','Science','Movies','Games','Random'];
  const samples=[
    ['Who was the first US president?','George Washington'],
    ['H2O is commonly known as?','Water'],
    ['Director of "Jurassic Park" (1993)?','Steven Spielberg'],
    ['Creator of Minecraft?','Markus "Notch" Persson'],
    ['Primary color not in RGB?','Yellow']
  ];
  for(let r=0;r<5;r++) for(let c=0;c<5;c++){ p1.grid[c][r]={q:samples[c%5][0], a:samples[c%5][1], used:false, dd:false}; }
  p1.grid[1][3].dd=true; p1.grid[3][4].dd=true; p1.final={q:'This planet is known as the Red Planet.', a:'What is Mars?'};

  // Sample 2 shorter
  const p2=makeEmpty(4,4,'Movie Night');
  p2.categories=['Pixar','Marvel','Star Wars','Quotes'];
  p2.final={q:'Famous line finishing: "May the ___ be with you."', a:'Force'};

  store.put(p1); store.put(p2);
}

(function init(){
  if(store.packs.length===0) seedSamples();
  refreshPackTable(); refreshPackSelect();
  // Default load first pack
  if(store.packs[0]){ currentPack=JSON.parse(JSON.stringify(store.packs[0])); buildBoard(); }
  buildEditorGrid(5,5);
  refreshPlayers();
})();
</script>
</body>
</html>
